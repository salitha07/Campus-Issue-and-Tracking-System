<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    th:lang="${#locale.language}">

<head>
    <title>Dashboard - Campus Issue Tracker</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link th:href="@{/css/dashboard.css}" rel="stylesheet">

    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">

        <h2 class="dashboard-title">Campus Issues Dashboard</h2>

        <div class="d-flex gap-2">

            <!-- Report button (students only) -->
            <a th:href="@{/report-options}" class="btn btn-success" sec:authorize="hasRole('STUDENT')"
                th:text="#{dashboard.reportNew}">
                + Report New Issue
            </a>

            <!-- Audit Trail button (staff/admin only) -->
            <a th:href="@{/audit-trail}" class="btn btn-info text-white" sec:authorize="hasAnyRole('STAFF', 'ADMIN')"
                th:text="#{dashboard.auditTrail}">
                View Audit Trail
            </a>

            <!-- Logout button -->
            <form th:action="@{/logout}" method="post">
                <button type="submit" class="btn btn-danger">
                    Logout
                </button>
            </form>

        </div>
    </div>

    <!-- Search/Filter Form -->
    <div class="card shadow-sm p-3 mb-4">
        <form th:action="@{/dashboard}" method="get" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="q" class="form-label fw-bold">Search</label>
                <input type="text" class="form-control" id="q" name="q" th:value="${q}"
                    placeholder="Title, Check, Loc...">
            </div>
            <div class="col-md-2">
                <label for="category" class="form-label fw-bold">Category</label>
                <select class="form-select" id="category" name="category">
                    <option value="">All</option>
                    <option th:each="cat : ${T(com.campus.issue_tracker.entity.IssueCategory).values()}"
                        th:if="${cat.name() != 'CAFETERIA'}" th:value="${cat}" th:text="${cat}"
                        th:selected="${cat == category}"></option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="status" class="form-label fw-bold">Status</label>
                <select class="form-select" id="status" name="status">
                    <option value="">All</option>
                    <option th:each="stat : ${T(com.campus.issue_tracker.entity.IssueStatus).values()}"
                        th:value="${stat}" th:text="${stat}" th:selected="${stat == status}"></option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="dateRange" class="form-label fw-bold">Date</label>
                <select class="form-select" id="dateRange" name="dateRange">
                    <option value="">Any Time</option>
                    <option value="today" th:selected="${dateRange == 'today'}">Today</option>
                    <option value="7days" th:selected="${dateRange == '7days'}">Last 7 Days</option>
                    <option value="30days" th:selected="${dateRange == '30days'}">Last 30 Days</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary me-2">Filter</button>
                <a th:href="@{/dashboard}" class="btn btn-secondary">Reset</a>
            </div>
        </form>
    </div>

    <div class="card shadow-lg p-4 dashboard-card">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>Reporter</th>
                    <th>Feedback</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>
                <tr th:each="issue : ${issues}">
                    <td th:text="${issue.id}"></td>
                    <td class="fw-bold" th:text="${issue.title}"></td>
                    <td>
                        <span class="badge bg-info text-dark" th:text="${issue.category}"></span>
                    </td>
                    <td th:text="${issue.location}"></td>

                    <td>
                        <span th:class="'badge ' + ${issue.status.name() == 'PENDING' ? 'bg-warning text-dark' :
                               (issue.status.name() == 'IN_PROGRESS' ? 'bg-primary' :
                               (issue.status.name() == 'RESOLVED' ? 'bg-success' : 'bg-danger'))}"
                            th:text="${issue.status}"></span>
                    </td>

                    <!-- Reporter display logic with anonymous masking -->
                    <td>
                        <span
                            th:if="${issue.anonymous and !#authorization.expression('hasAnyRole(''STAFF'', ''ADMIN'')') and (#authentication.name != issue.reporter.username)}"
                            th:text="#{dashboard.anonymous}">Anonymous</span>

                        <span
                            th:unless="${issue.anonymous and !#authorization.expression('hasAnyRole(''STAFF'', ''ADMIN'')') and (#authentication.name != issue.reporter.username)}"
                            th:text="${issue.reporter.username}"></span>
                    </td>

                    <!-- Feedback visible only to staff/admin OR reporter -->
                    <td
                        th:if="${#authorization.expression('hasAnyRole(''STAFF'', ''ADMIN'')') or (#authentication.name == issue.reporter.username)}">
                        <div>
                            <span th:if="${issue.rating}" class="text-warning">
                                <span th:each="i : ${#numbers.sequence(1, issue.rating)}">&#9733;</span>
                            </span>
                        </div>
                        <small class="text-muted" th:if="${issue.studentFeedback}"
                            th:text="${issue.studentFeedback}"></small>
                        <small class="text-muted" th:unless="${issue.studentFeedback}"
                            th:text="#{dashboard.noFeedback}">No feedback</small>
                    </td>

                    <td
                        th:unless="${#authorization.expression('hasAnyRole(''STAFF'', ''ADMIN'')') or (#authentication.name == issue.reporter.username)}">
                        <span class="text-muted">Private</span>
                    </td>

                    <td>
                        <div class="d-flex align-items-center">

                            <!-- View Details -->
                            <button type="button" class="btn btn-view-details me-3"
                                th:if="${!issue.anonymous or #authorization.expression('hasAnyRole(''STAFF'', ''ADMIN'')') or (issue.reporter.username == #authentication.name)}"
                                data-bs-toggle="modal" data-bs-target="#issueModal" th:data-id="${issue.id}"
                                th:data-title="${issue.title}" th:data-category="${issue.category}"
                                th:data-desc="${issue.description}" th:data-loc="${issue.location}"
                                th:data-status="${issue.status}" th:data-reporter="${issue.reporter.username}"
                                th:data-feedback="${issue.studentFeedback}" th:data-rating="${issue.rating}"
                                th:data-is-reporter="${issue.reporter.username == #authentication.name}"
                                th:data-lat="${issue.latitude}" th:data-lng="${issue.longitude}"
                                th:data-attachment="${issue.attachmentPath}">
                                View Details
                            </button>

                            <span class="text-muted me-3"
                                th:unless="${!issue.anonymous or #authorization.expression('hasAnyRole(''STAFF'', ''ADMIN'')') or (issue.reporter.username == #authentication.name)}">
                                Staff only
                            </span>

                            <!-- Staff/admin status update -->
                            <div th:if="${#authorization.expression('hasAnyRole(''STAFF'', ''ADMIN'')')}"
                                class="status-update-group d-flex">
                                <select class="form-select form-select-sm me-2 status-dropdown"
                                    th:id="'status-' + ${issue.id}">
                                    <option th:selected="${issue.status.name() == 'PENDING'}" value="PENDING">PENDING
                                    </option>
                                    <option th:selected="${issue.status.name() == 'IN_PROGRESS'}" value="IN_PROGRESS">
                                        IN_PROGRESS</option>
                                    <option th:selected="${issue.status.name() == 'RESOLVED'}" value="RESOLVED">RESOLVED
                                    </option>
                                    <option th:selected="${issue.status.name() == 'REJECTED'}" value="REJECTED">REJECTED
                                    </option>
                                </select>

                                <button class="btn btn-sm btn-primary" th:onclick="'updateStatus(' + ${issue.id} + ')'"
                                    th:text="#{dashboard.update}">
                                    Update
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Pagination (FIXED: no merge markers + keeps filters) -->
        <nav class="mt-3" th:if="${totalPages > 1}">
            <ul class="pagination justify-content-center">

                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                    <a class="page-link"
<<<<<<< HEAD
                       th:href="@{/dashboard(page=${currentPage - 1}, q=${q}, category=${category}, status=${status}, dateRange=${dateRange})}"

                       th:text="#{dashboard.previous}">
=======
                        th:href="@{/dashboard(page=${currentPage-1}, q=${q}, category=${category}, status=${status}, dateRange=${dateRange})}"
                        th:text="#{dashboard.previous}">
>>>>>>> 68847bcf9240fc77ac923badcc02d60b475d4797
                        Previous
                    </a>
                </li>

<<<<<<< HEAD
                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}
                "
=======
                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages-1)}"
>>>>>>> 68847bcf9240fc77ac923badcc02d60b475d4797
                    th:classappend="${i == currentPage} ? 'active'">
                    <a class="page-link"
                        th:href="@{/dashboard(page=${i}, q=${q}, category=${category}, status=${status}, dateRange=${dateRange})}"
                        th:text="${i+1}"></a>
                </li>

                <li class="page-item" th:classappend="${currentPage+1 >= totalPages} ? 'disabled'">
                    <a class="page-link"
                        th:href="@{/dashboard(page=${currentPage+1}, q=${q}, category=${category}, status=${status}, dateRange=${dateRange})}"
                        th:text="#{dashboard.next}">
                        Next
                    </a>
                </li>

            </ul>
        </nav>
    </div>

    <!-- Issue Details Modal -->
    <div class="modal fade" id="issueModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Issue Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p><strong>ID:</strong> <span id="modalId"></span></p>
                    <p><strong>Title:</strong> <span id="modalIssueTitle"></span></p>
                    <p><strong>Category:</strong> <span id="modalCategory"></span></p>
                    <p><strong>Description:</strong> <span id="modalDesc"></span></p>
                    <p><strong>Location:</strong> <span id="modalLoc"></span></p>
                    <p><strong>Status:</strong> <span id="modalStatus"></span></p>
                    <p><strong>Reporter:</strong> <span id="modalReporter"></span></p>

                    <hr />
                    <h6>Issue Location Map</h6>
                    <div id="issueMap" style="height: 280px; border-radius: 12px;"></div>

                    <div class="mt-3" id="attachmentBlock" style="display:none;">
                        <h6 th:text="#{modal.attachment}">Attachment</h6>
                        <a id="attachmentLink" target="_blank" class="btn btn-sm btn-outline-primary"
                            th:text="#{modal.viewAttachment}">View Attachment</a>
                    </div>

                    <hr />

                    <div id="feedbackSection">
                        <h6>Feedback</h6>
                        <div id="modalStars" class="text-warning mb-1"></div>
                        <p id="modalFeedback" class="text-muted mb-0"></p>
                    </div>

                    <div class="mt-4" sec:authorize="hasRole('STUDENT')">
                        <h6>Add / Update Feedback (Only for your issue)</h6>
                        <textarea class="form-control mb-2" id="feedbackInput" rows="2"
                            placeholder="Write feedback..."></textarea>

                        <label class="form-label mb-1">Rating</label>
                        <select class="form-select mb-3" id="ratingInput">
                            <option value="">No rating</option>
                            <option value="1">1 ⭐</option>
                            <option value="2">2 ⭐⭐</option>
                            <option value="3">3 ⭐⭐⭐</option>
                            <option value="4">4 ⭐⭐⭐⭐</option>
                            <option value="5">5 ⭐⭐⭐⭐⭐</option>
                        </select>

                        <button class="btn btn-primary" onclick="submitFeedback()" th:text="#{modal.submitFeedback}">
                            Submit Feedback
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        let selectedIssueId = null;
        let mapInstance = null;
        let markerInstance = null;

        const csrfMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;
        const csrfHeader = csrfHeaderMeta ? csrfHeaderMeta.getAttribute('content') : null;

        const issueModalEl = document.getElementById("issueModal");

        issueModalEl.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            if (!button) return;

            selectedIssueId = button.getAttribute("data-id") || "";

            const title = button.getAttribute("data-title") || "";
            const category = button.getAttribute("data-category") || "-";
            const desc = button.getAttribute("data-desc") || "";
            const loc = button.getAttribute("data-loc") || "";
            const status = button.getAttribute("data-status") || "";
            const reporter = button.getAttribute("data-reporter") || "";

            const feedback = button.getAttribute("data-feedback") || "";
            const rating = button.getAttribute("data-rating") || "";
            const isReporter = button.getAttribute("data-is-reporter") === "true";

            const latAttr = button.getAttribute("data-lat");
            const lngAttr = button.getAttribute("data-lng");
            const lat = latAttr ? parseFloat(latAttr) : NaN;
            const lng = lngAttr ? parseFloat(lngAttr) : NaN;

            const attachment = button.getAttribute("data-attachment") || "";

            document.getElementById("modalId").innerText = selectedIssueId;
            document.getElementById("modalIssueTitle").innerText = title;
            document.getElementById("modalCategory").innerText = category;
            document.getElementById("modalDesc").innerText = desc;
            document.getElementById("modalLoc").innerText = loc;
            document.getElementById("modalStatus").innerText = status;
            document.getElementById("modalReporter").innerText = reporter;

            const attachmentBlock = document.getElementById("attachmentBlock");
            const attachmentLink = document.getElementById("attachmentLink");
            if (attachment && attachment.trim() !== "") {
                attachmentBlock.style.display = "block";
                attachmentLink.href = "/uploads/" + attachment;
            } else {
                attachmentBlock.style.display = "none";
            }

            const starsDiv = document.getElementById("modalStars");
            starsDiv.innerHTML = "";
            if (rating) {
                const r = parseInt(rating);
                if (!isNaN(r)) {
                    for (let i = 0; i < r; i++) starsDiv.innerHTML += "&#9733;";
                }
            }

            document.getElementById("modalFeedback").innerText = feedback ? feedback : "No feedback";

            const feedbackInput = document.getElementById("feedbackInput");
            const ratingInput = document.getElementById("ratingInput");
            if (feedbackInput) feedbackInput.disabled = !isReporter;
            if (ratingInput) ratingInput.disabled = !isReporter;

            setTimeout(() => {
                if (!isNaN(lat) && !isNaN(lng)) {
                    if (mapInstance) {
                        mapInstance.remove();
                        mapInstance = null;
                    }
                    mapInstance = L.map("issueMap").setView([lat, lng], 17);
                    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                        maxZoom: 19,
                        attribution: "© OpenStreetMap"
                    }).addTo(mapInstance);

                    markerInstance = L.marker([lat, lng]).addTo(mapInstance);
                    setTimeout(() => mapInstance.invalidateSize(), 200);
                }
            }, 250);
        });

        function updateStatus(issueId) {
            const selected = document.getElementById("status-" + issueId).value;

            fetch(`/api/issues/${issueId}/status?status=${selected}`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    ...(csrfToken && csrfHeader ? { [csrfHeader]: csrfToken } : {})
                }
            }).then(() => window.location.reload());
        }

        function submitFeedback() {
            const feedbackEl = document.getElementById("feedbackInput");
            const ratingEl = document.getElementById("ratingInput");

            const feedback = feedbackEl ? feedbackEl.value : "";
            const rating = ratingEl ? ratingEl.value : "";

            const params = new URLSearchParams();
            if (feedback) params.append("feedback", feedback);
            if (rating) params.append("rating", rating);

            fetch(`/api/issues/${selectedIssueId}/feedback?` + params.toString(), {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    ...(csrfToken && csrfHeader ? { [csrfHeader]: csrfToken } : {})
                }
            }).then(() => window.location.reload());
        }
    </script>

</body>

</html>