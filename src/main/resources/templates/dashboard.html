<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <title>Dashboard - Campus Issue Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link th:href="@{/css/dashboard.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- ✅ CSRF meta tags (needed for PATCH/POST via fetch) -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="container mt-5">
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Campus Issues Dashboard</h2>
    <div>
        <a href="/report" class="btn btn-success" sec:authorize="hasRole('STUDENT')">Report New Issue</a>
        <form th:action="@{/logout}" method="post" style="display: inline;">
            <button type="submit" class="btn btn-danger">Logout</button>
        </form>
    </div>
</div>

<div class="alert alert-info" sec:authorize="hasAnyRole('STAFF', 'ADMIN')">
    <strong>Staff Mode:</strong> You can update issue status and manage reports.
</div>

<div class="dashboard-card p-4">
    <table class="table table-hover mb-0">
        <thead>
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Location</th>
            <th>Status</th>
            <th>Reporter</th>
            <th>Feedback</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="issue : ${issues}">
            <td th:text="${issue.id}"></td>
            <td class="fw-bold" th:text="${issue.title}"></td>
            <td th:text="${issue.location}"></td>
            <td>
                <span th:class="'badge ' + ${issue.status.name() == 'PENDING' ? 'bg-warning text-dark' :
                               (issue.status.name() == 'IN_PROGRESS' ? 'bg-primary' :
                               (issue.status.name() == 'RESOLVED' ? 'bg-success' : 'bg-danger'))}"
                      th:text="${issue.status}"></span>
            </td>
            <td th:text="${issue.reporter.username}"></td>

            <td th:if="${#authorization.expression('hasAnyRole(''STAFF'', ''ADMIN'')') or (#authentication.name == issue.reporter.username)}">
                <div>
                    <span th:if="${issue.rating}" class="text-warning">
                        <span th:each="i : ${#numbers.sequence(1, issue.rating)}">&#9733;</span>
                    </span>
                </div>
                <small class="text-muted" th:if="${issue.studentFeedback}" th:text="${issue.studentFeedback}"></small>
                <small class="text-muted fst-italic" th:unless="${issue.studentFeedback}">No feedback yet</small>
            </td>

            <td th:unless="${#authorization.expression('hasAnyRole(''STAFF'', ''ADMIN'')') or (#authentication.name == issue.reporter.username)}">
                <span class="text-muted">Private</span>
            </td>

            <td>
                <div class="d-flex align-items-center">
                    <button type="button"
                            class="btn btn-view-details me-3"
                            data-bs-toggle="modal"
                            data-bs-target="#issueModal"
                            th:data-id="${issue.id}"
                            th:data-title="${issue.title}"
                            th:data-desc="${issue.description}"
                            th:data-loc="${issue.location}"
                            th:data-status="${issue.status}"
                            th:data-reporter="${issue.reporter.username}"
                            th:data-feedback="${issue.studentFeedback}"
                            th:data-rating="${issue.rating}"
                            th:data-is-reporter="${issue.reporter.username == #authentication.name}"
                            th:data-lat="${issue.latitude}"
                            th:data-lng="${issue.longitude}"
                            th:data-attachment="${issue.attachmentPath}">
                        View Details
                    </button>

                    <div th:if="${#authorization.expression('hasAnyRole(''STAFF'', ''ADMIN'')')}"
                         class="status-update-group d-flex">
                        <select class="form-select status-select" th:id="'status-' + ${issue.id}">
                            <option th:each="s : ${T(com.campus.issue_tracker.entity.IssueStatus).values()}"
                                    th:value="${s}"
                                    th:text="${s}"
                                    th:selected="${s.name() == issue.status.name()}">
                            </option>
                        </select>
                        <button type="button"
                                class="btn btn-update-status btn-sm px-3"
                                th:onclick="'updateStatus(' + ${issue.id} + ')'">
                            Update
                        </button>
                    </div>
                </div>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Issue Details Modal -->
<div class="modal fade" id="issueModal" tabindex="-1" aria-labelledby="issueModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="issueModalLabel">Issue Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <p><strong>ID:</strong> <span id="modal-id"></span></p>
                <p><strong>Title:</strong> <span id="modal-title"></span></p>
                <p><strong>Location:</strong> <span id="modal-loc"></span></p>
                <p><strong>Status:</strong> <span id="modal-status" class="badge"></span></p>
                <p><strong>Reporter:</strong> <span id="modal-reporter"></span></p>

                <hr>
                <p><strong>Description:</strong></p>
                <p id="modal-desc" class="text-secondary"></p>

                <hr>
                <div class="mt-2">
                    <h6>Issue Location on Map</h6>
                    <div id="modal-map" style="height: 260px; border-radius: 12px;"></div>
                </div>

                <hr>
                <div class="mt-2">
                    <h6>Evidence Photo</h6>
                    <img id="modal-image" src="" alt="Issue evidence"
                         class="img-fluid rounded"
                         style="display:none; max-height:320px; object-fit:contain;">
                    <div id="no-image" class="text-muted" style="display:none;">No image uploaded.</div>
                </div>

                <div id="feedback-section" style="display: none;">
                    <hr>
                    <h6>Student Feedback</h6>

                    <div id="feedback-input-group" style="display: none;">
                        <div class="star-rating mb-2" id="modal-star-selector">
                            <span class="star" data-value="5" onclick="setRating(5)">&#9733;</span>
                            <span class="star" data-value="4" onclick="setRating(4)">&#9733;</span>
                            <span class="star" data-value="3" onclick="setRating(3)">&#9733;</span>
                            <span class="star" data-value="2" onclick="setRating(2)">&#9733;</span>
                            <span class="star" data-value="1" onclick="setRating(1)">&#9733;</span>
                        </div>

                        <input type="hidden" id="modal-rating-value" value="0">
                        <textarea class="form-control mb-2" id="modal-feedback-input" rows="3"
                                  placeholder="How was the resolution?"></textarea>
                        <button type="button" class="btn btn-info btn-sm" id="submit-feedback-btn">Submit Feedback</button>
                    </div>

                    <div id="feedback-display" style="display: none;">
                        <div id="modal-rating-display" class="text-warning h5 mb-1"></div>
                        <p class="fst-italic text-muted" id="modal-feedback-text"></p>
                    </div>

                    <div id="feedback-locked-msg" class="alert alert-warning py-1" style="display: none;">
                        <small>Feedback can only be provided after staff update the status.</small>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<nav th:if="${totalPages > 1}">
    <ul class="pagination">
        <li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
            <a class="page-link" th:href="@{/dashboard(page=${currentPage - 1})}">Previous</a>
        </li>
        <li class="page-item" th:classappend="${currentPage + 1 == totalPages ? 'disabled' : ''}">
            <a class="page-link" th:href="@{/dashboard(page=${currentPage + 1})}">Next</a>
        </li>
    </ul>
</nav>

<!-- ✅ Leaflet JS must be loaded before map code -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // ✅ CSRF helper for fetch requests (PATCH)
    function csrfHeaders() {
        const tokenEl = document.querySelector('meta[name="_csrf"]');
        const headerEl = document.querySelector('meta[name="_csrf_header"]');
        if (!tokenEl || !headerEl) return {};
        const token = tokenEl.getAttribute('content');
        const header = headerEl.getAttribute('content');
        return { [header]: token };
    }

    // Fill modal + feedback UI
    const issueModal = document.getElementById('issueModal');
    issueModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;

        const id = button.getAttribute('data-id');
        const title = button.getAttribute('data-title');
        const desc = button.getAttribute('data-desc');
        const loc = button.getAttribute('data-loc');
        const status = button.getAttribute('data-status');

        const attachment = button.getAttribute('data-attachment');
        const imgEl = document.getElementById('modal-image');
        const noImgEl = document.getElementById('no-image');

        if (attachment && attachment !== 'null' && attachment.trim() !== '') {
            imgEl.src = '/uploads/' + encodeURIComponent(attachment);
            imgEl.style.display = 'block';
            noImgEl.style.display = 'none';
        } else {
            imgEl.src = '';
            imgEl.style.display = 'none';
            noImgEl.style.display = 'block';
        }

        const reporter = button.getAttribute('data-reporter');
        const feedback = button.getAttribute('data-feedback');
        const rating = button.getAttribute('data-rating');
        const isReporter = button.getAttribute('data-is-reporter') === 'true';

        document.getElementById('modal-id').textContent = id || '';
        document.getElementById('modal-title').textContent = title || '';
        document.getElementById('modal-desc').textContent = desc || '';
        document.getElementById('modal-loc').textContent = loc || '';
        document.getElementById('modal-reporter').textContent = reporter || '';

        const statusBadge = document.getElementById('modal-status');
        statusBadge.textContent = status || '';

        let badgeClass = 'badge ';
        if (status === 'PENDING') badgeClass += 'bg-warning text-dark';
        else if (status === 'IN_PROGRESS') badgeClass += 'bg-primary';
        else if (status === 'RESOLVED') badgeClass += 'bg-success';
        else if (status === 'REJECTED') badgeClass += 'bg-danger';
        statusBadge.className = badgeClass;

        const feedbackSection = document.getElementById('feedback-section');
        const feedbackInputGroup = document.getElementById('feedback-input-group');
        const feedbackDisplay = document.getElementById('feedback-display');
        const feedbackLockedMsg = document.getElementById('feedback-locked-msg');
        const feedbackText = document.getElementById('modal-feedback-text');
        const ratingDisplay = document.getElementById('modal-rating-display');
        const feedbackInput = document.getElementById('modal-feedback-input');
        const submitBtn = document.getElementById('submit-feedback-btn');

        if (isReporter) {
            feedbackSection.style.display = 'block';
            if (status === 'PENDING') {
                feedbackInputGroup.style.display = 'none';
                feedbackDisplay.style.display = 'none';
                feedbackLockedMsg.style.display = 'block';
            } else {
                feedbackLockedMsg.style.display = 'none';
                if (feedback && feedback !== 'null' && feedback.trim() !== '') {
                    feedbackInputGroup.style.display = 'none';
                    feedbackDisplay.style.display = 'block';
                    feedbackText.textContent = feedback;

                    ratingDisplay.innerHTML = '';
                    if (rating && rating !== 'null') {
                        for (let i = 0; i < parseInt(rating); i++) {
                            ratingDisplay.innerHTML += '&#9733;';
                        }
                    }
                } else {
                    feedbackInputGroup.style.display = 'block';
                    feedbackDisplay.style.display = 'none';
                    feedbackInput.value = '';
                    setRating(0);
                    submitBtn.onclick = () => addFeedback(id);
                }
            }
        } else {
            feedbackSection.style.display = 'none';
        }
    });

    function setRating(val) {
        document.getElementById('modal-rating-value').value = val;
        const stars = document.querySelectorAll('#modal-star-selector .star');
        stars.forEach(star => {
            const starValue = parseInt(star.getAttribute('data-value'));
            if (starValue <= val) star.classList.add('selected');
            else star.classList.remove('selected');
        });
    }

    // ✅ Staff updates status (PATCH + CSRF)
    async function updateStatus(id) {
        const status = document.getElementById('status-' + id).value;
        try {
            const response = await fetch(`/api/issues/${id}/status?status=${encodeURIComponent(status)}`, {
                method: 'PATCH',
                headers: {
                    ...csrfHeaders()
                }
            });

            if (response.ok) {
                location.reload();
            } else {
                const text = await response.text();
                alert('Failed to update status: ' + response.status + ' ' + text);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred');
        }
    }

    // ✅ Student adds feedback (PATCH + CSRF)
    async function addFeedback(id) {
        const feedback = document.getElementById('modal-feedback-input').value;
        const rating = document.getElementById('modal-rating-value').value;

        if (!feedback.trim() && rating === "0") {
            alert('Please provide at least a star rating or feedback text.');
            return;
        }

        try {
            const url = `/api/issues/${id}/feedback?` +
                (feedback.trim() ? `feedback=${encodeURIComponent(feedback)}&` : '') +
                (rating !== "0" ? `rating=${rating}` : '');

            const response = await fetch(url, {
                method: 'PATCH',
                headers: {
                    ...csrfHeaders()
                }
            });

            if (response.ok) {
                location.reload();
            } else {
                const text = await response.text();
                alert('Failed to submit feedback: ' + response.status + ' ' + text);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred');
        }
    }

    // ✅ Map inside modal
    let modalMap = null;
    const issueModalEl = document.getElementById('issueModal');

    issueModalEl.addEventListener('shown.bs.modal', function (event) {
        const button = event.relatedTarget;
        const lat = button.getAttribute('data-lat');
        const lng = button.getAttribute('data-lng');
        const mapContainer = document.getElementById('modal-map');

        if (!lat || !lng) {
            mapContainer.innerHTML = "<div class='alert alert-warning mb-0'>No map location saved for this issue.</div>";
            return;
        }

        if (modalMap) {
            modalMap.remove();
            modalMap = null;
        }
        mapContainer.innerHTML = "";

        modalMap = L.map('modal-map').setView([lat, lng], 18);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(modalMap);

        L.marker([lat, lng]).addTo(modalMap);

        // Fix sizing inside modal
        setTimeout(() => modalMap.invalidateSize(), 200);
    });

    issueModalEl.addEventListener('hidden.bs.modal', function () {
        if (modalMap) {
            modalMap.remove();
            modalMap = null;
        }
        const mapContainer = document.getElementById('modal-map');
        if (mapContainer) mapContainer.innerHTML = "";
    });
</script>

</body>
</html>
