<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <title>Dashboard - Campus Issue Tracker</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <link th:href="@{/css/dashboard.css}" rel="stylesheet">

    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="container mt-5">

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="dashboard-title">Campus Issues Dashboard</h2>

    <div class="d-flex gap-2">

        <a href="/report-options"
           class="btn btn-success"
           sec:authorize="hasRole('STUDENT')">
            + Report New Issue
        </a>

        <form th:action="@{/logout}" method="post">
            <button type="submit" class="btn btn-danger">Logout</button>
        </form>

    </div>
</div>

<div class="card shadow-lg p-4 dashboard-card">

    <table class="table table-hover align-middle">

        <thead>
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Location</th>
            <th>Status</th>
            <th>Escalation</th>
            <th>Next Escalation</th> <!-- ✅ NEW TIMER COLUMN -->
            <th>Reporter</th>
            <th>Feedback</th>
            <th>Actions</th>
        </tr>
        </thead>

        <tbody>

        <tr th:each="issue : ${issues}"
            th:data-created="${issue.createdAt}"
            th:data-lastEscalated="${issue.lastEscalatedAt}"
            th:data-status="${issue.status}">

            <td th:text="${issue.id}"></td>

            <td class="fw-bold" th:text="${issue.title}"></td>

            <td th:text="${issue.location}"></td>

            <td>
<span th:class="'badge ' + ${issue.status.name() == 'PENDING' ? 'bg-warning text-dark' :
(issue.status.name() == 'IN_PROGRESS' ? 'bg-primary' :
(issue.status.name() == 'RESOLVED' ? 'bg-success' : 'bg-danger'))}"
      th:text="${issue.status}">
</span>
            </td>

            <td>
<span th:if="${issue.escalationLevel == 0}"
      class="badge bg-success">Normal</span>

                <span th:if="${issue.escalationLevel == 1}"
                      class="badge bg-warning text-dark">Escalated L1</span>

                <span th:if="${issue.escalationLevel >= 2}"
                      class="badge bg-danger">Escalated L2</span>
            </td>

            <!-- ⏱️ TIMER -->
            <td>
<span class="badge bg-info countdown-timer">
Calculating...
</span>
            </td>

            <td th:text="${issue.reporter.username}"></td>

            <td>
                <small class="text-muted"
                       th:text="${issue.studentFeedback != null ? issue.studentFeedback : 'No feedback'}">
                </small>
            </td>

            <td>
                <span class="text-muted">View</span>
            </td>

        </tr>

        </tbody>
    </table>
</div>

<!-- ✅ STEP 3 SCRIPT -->
<script>

    function updateTimers() {

        document.querySelectorAll("tbody tr").forEach(row => {

            const created = row.dataset.created;
            const lastEscalated = row.dataset.lastescalated;
            const status = row.dataset.status;

            const badge = row.querySelector(".countdown-timer");

            if(status === "RESOLVED"){
                badge.innerText = "Resolved";
                return;
            }

            let baseTime = lastEscalated ? new Date(lastEscalated) : new Date(created);

            let nextEscalation = new Date(baseTime.getTime() + (6 * 60 * 60 * 1000));

            let diff = nextEscalation - new Date();

            if(diff <= 0){
                badge.innerText = "Escalating...";
                return;
            }

            let hours = Math.floor(diff / (1000 * 60 * 60));
            let minutes = Math.floor((diff % (1000*60*60))/(1000*60));

            badge.innerText = hours + "h " + minutes + "m";

        });

    }

    setInterval(updateTimers,1000);
    updateTimers();

</script>

</body>
</html>
