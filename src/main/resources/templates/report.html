
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Report Issue</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

</head>

<body class="container mt-5">
    <h2>Report a Campus Issue</h2>
    <form id="reportForm" th:action="@{/report}" method="post" enctype="multipart/form-data" class="card p-4 shadow">
        <div class="mb-3">
            <label class="form-label">Issue Title</label>
            <input type="text" id="title" name="title" class="form-control" placeholder="e.g. Broken Light" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Location</label>
            <input type="text" id="location" name="location" class="form-control" placeholder="e.g. Block A, Room 102"
                required>
        </div>
        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">

        <div class="mb-3">
            <label class="form-label">Select Issue Location (NSBM Map)</label>
            <div id="map" style="height: 350px; border-radius: 12px;"></div>
            <small class="text-muted">Click the map and select Location.</small>
        </div>

        <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3" required></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label">Evidence Photo</label>
            <input type="file" name="file" class="form-control">
        </div>
        <button type="submit" class="btn btn-success">Submit Report</button>
    </form>

    <script>
        document.getElementById('reportForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const form = this;
            const title = document.getElementById('title').value;
            const location = document.getElementById('location').value;
const lat = document.getElementById('latitude').value;
const lng = document.getElementById('longitude').value;

if (!lat || !lng) {
  alert("Please select the issue location on the NSBM map.");
  return;
}

            try {
                const response = await fetch(`/api/issues/check-duplicate?title=${encodeURIComponent(title)}&location=${encodeURIComponent(location)}`);
                const isDuplicate = await response.json();

                if (isDuplicate) {
                    const confirmContinue = confirm("Similar issue already exists. Do you want to continue?");
                    if (!confirmContinue) {
                        return; // Stop submission
                    }
                }
                form.submit();
            } catch (error) {
                console.error('Error checking for duplicates:', error);
                form.submit(); // Submit anyway if check fails
            }
        });
    </script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const nsbmLat = 6.8213;
        const nsbmLng = 80.0410;

        const map = L.map('map').setView([nsbmLat, nsbmLng], 17);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let marker;

        map.on('click', function (e) {
          const lat = e.latlng.lat;
          const lng = e.latlng.lng;

          if (marker) marker.remove();
          marker = L.marker([lat, lng]).addTo(map);

          document.getElementById('latitude').value = lat;
          document.getElementById('longitude').value = lng;
        });
    </script>

</body>

</html>